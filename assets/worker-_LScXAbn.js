(function(){"use strict";function l(t){const e=new Map,n=new Set(t.data.map(a=>{const r=a.toString();return e.set(r,a),r}));return{map:e,set:n}}function f(t,e,n){let a=0;for(let r=0;r<t;r++)a+=(e[r]-n[r])**2;return a}function h(t,e,n){return Math.sqrt(f(t,e,n))}function m(t){if(t.length<1)throw Error("too few nums");let e=[0,t[0]];for(let n=1;n<t.length;n++)t[n]<e[1]&&(e=[n,t[n]]);return e}function d(t,e){if(e.length===0)throw Error("too few elements");const n=[];for(let a=0;a<t;a++)n[a]=e.reduce((r,s)=>r+=s[a],0)/e.length;return n}function p(t){const e=new Array(t.dimension).fill(1/0),n=new Array(t.dimension).fill(-1/0);for(const a of t.data)for(let r=0;r<t.dimension;r++)a[r]<e[r]&&(e[r]=a[r]),a[r]>n[r]&&(n[r]=a[r]);return{min:e,max:n}}function u(t,e,n,a=[],r=0){r++;const s=a.slice();for(;s.length<e;)s.push(_(n));const o=g(t,s,r);return w(t.dimension,s,o.means)?o:u(t,e,n,o.means,r)}function g(t,e,n){const a=new Map;for(const r of e)a.set(r,[]);for(const r of t.data){const[s]=m(e.map(o=>h(t.dimension,o,r)));a.get(e[s]).push(r)}return new b(n,t.dimension,Array.from(a.values()).filter(r=>r.length))}function _(t){const e=[];for(let n=0;n<t.min.length;n++){const a=t.max[n]-t.min[n];e[n]=Math.random()*a+t.min[n]}return e}function w(t,e,n){const a=(s,o)=>{for(let i=0;i<t;i++)if(s[i]!==o[i])return!1;return!0},r=e.length;if(r!==n.length)return!1;for(let s=0;s<r;s++)if(!a(e[s],n[s]))return!1;return!0}class b{constructor(e,n,a){Object.defineProperty(this,"count",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"clusters",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"means",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const r=[];this.clusters=a.map(s=>{const o=d(n,s);return r.push(o),{mean:o,points:s}}),this.means=r}}function k(t,e,n){const r=[t.data[Math.floor(t.data.length*Math.random())]];for(;r.length<e;)r.push(y(t,r));return u(t,e,n,r)}function y(t,e){const n=t.data.map(o=>{const i=e.map(x=>f(t.dimension,x,o));return m(i)[1]}),a=n.reduce((o,i)=>o+i,0),r=Math.random()*a;let s=0;for(let o=0;o<t.data.length;o++)if(s+=n[o],s>=r)return t.data[o];return t.data[t.data.length-1]}class v{constructor(e){Object.defineProperty(this,"points",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"range",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.range=new M(()=>p(this.points))}k_means(e){const n=l(this.points);return n.set.size<e?Array.from(n.map.values()):u(this.points,e,this.range.val)}k_means_pp(e){const n=l(this.points);return n.set.size<e?Array.from(n.map.values()):k(this.points,e,this.range.val)}}class M{constructor(e){Object.defineProperty(this,"make",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get val(){return this.value??(this.value=this.make())}}function P(t){if(t instanceof ImageData)return t;var e;if(t instanceof HTMLImageElement){const n=t;t=new OffscreenCanvas(n.width,n.height),e=t.getContext("2d"),e.drawImage(n,0,0)}else e=t.getContext("2d");return e.getImageData(0,0,t.width,t.height)}class O{constructor(e){e=P(e),this.kmpp=new v({data:q(e),dimension:4})}ret(e){const n=e instanceof Array?e:e.means;return{kmpp_result:e,colors:j(n)}}k_colors(e){return this.ret(this.kmpp.k_means(e))}k_colors_pp(e){return this.ret(this.kmpp.k_means_pp(e))}}function j(t){return t.map(e=>e.map(n=>Math.round(n)))}function q(t){const e=t.data,n=[];for(let a=0;a<e.length;a+=4)n.push([e[a],e[a+1],e[a+2],e[a+3]]);return n}let c;self.onmessage=function(t){const{type:e,id:n,data:a}=t.data;switch(e){case"init":c=new O(a);break;case"k_colors":const r={id:n,result:c.k_colors(a)};postMessage(r);break;case"k_colors_pp":const s={id:n,result:c.k_colors_pp(a)};postMessage(s);break;default:throw new Error("unknown message type")}}})();
